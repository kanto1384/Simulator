private System.Windows.Forms.Timer? _autoExtractTimer;
private bool _autoExtractBusy;
private bool _sawLoadingOverlay;   // 로딩이 "한번이라도" 나타났는지

StartAutoExtractWatcher();

private void StartAutoExtractWatcher()
{
    if (_autoExtractTimer != null) return;

    _autoExtractTimer = new System.Windows.Forms.Timer();
    _autoExtractTimer.Interval = 500; // 평소엔 0.5초(충분히 가벼움)
    _autoExtractTimer.Tick += async (s, e) =>
    {
        if (_autoExtractBusy) return;
        if (_web.CoreWebView2 == null) return;

        _autoExtractBusy = true;
        try
        {
            // 1) 로딩 오버레이 존재 여부 (#id_line / #cont)
            bool isLoading = await JsHasAnyAsync("#id_line", "#cont");

            if (isLoading)
            {
                // 로딩을 봤다면 "끝나는 순간"을 기다리기 위해 플래그 ON
                _sawLoadingOverlay = true;

                // 로딩 중엔 더 빨리 감시(체감 속도 ↑)
                if (_autoExtractTimer.Interval != 200) _autoExtractTimer.Interval = 200;
                return;
            }

            // 로딩이 없으면 감시 주기 원복(자원 ↓)
            if (_autoExtractTimer.Interval != 500) _autoExtractTimer.Interval = 500;

            // 2) "로딩이 있었다가 -> 사라진 순간"에만 추출
            if (!_sawLoadingOverlay) return;

            // 로딩이 끝났다고 판단했으니 플래그 초기화
            _sawLoadingOverlay = false;

            // 3) 테이블 준비 확인 (원하는 셀 존재하면 준비 완료)
            bool tableReady = await JsExistsAsync("#user_access_list table#seltable tbody tr td");
            if (!tableReady)
            {
                // 로딩 오버레이는 사라졌지만 테이블이 아직 준비 안 된 경우가 있을 수 있어
                // 다음 tick에 다시 잡게끔 로딩 플래그를 다시 켜는 대신,
                // "준비될 때까지" 한두 번 더 확인하도록 살짝 재시도 상태로 돌림
                _sawLoadingOverlay = true;
                return;
            }

            // 4) 자동 추출 호출 (네 기존 메서드)
            await ExtractAndShowAsync();
        }
        catch
        {
            // 페이지 전환 중/일시 오류는 무시하고 다음 tick에서 재시도
        }
        finally
        {
            _autoExtractBusy = false;
        }
    };

    _autoExtractTimer.Start();
}

private async Task<bool> JsHasAnyAsync(params string[] selectors)
{
    // selectors 중 하나라도 존재하면 true
    var selArray = string.Join(",", selectors.Select(s => $"'{s.Replace("'", "\\'")}'"));
    string js = $"""
        (() => {{
            const sels = [{selArray}];
            for (const s of sels) {{
                if (document.querySelector(s)) return true;
            }}
            return false;
        }})()
    """;

    var raw = await _web.CoreWebView2.ExecuteScriptAsync(js);
    // WebView2는 "true"/"false" 문자열로 주는 경우가 많음
    return raw.Contains("true", StringComparison.OrdinalIgnoreCase);
}

private async Task<bool> JsExistsAsync(string selector)
{
    string js = $"""
        (() => !!document.querySelector('{selector.Replace("'", "\\'")}'))()
    """;
    var raw = await _web.CoreWebView2.ExecuteScriptAsync(js);
    return raw.Contains("true", StringComparison.OrdinalIgnoreCase);
}
