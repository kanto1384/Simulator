private System.Windows.Forms.Timer? _autoExtractTimer;
private bool _autoExtractBusy;

// 마지막 테이블 상태(변화 감지용)
private int _lastRowCount = -1;
private string _lastFirstKey = "";

private async Task<bool> JsHasLoadingOverlayAsync()
{
    // ✅ Id_line / id_line 둘 다 체크
    string js =
        "(function(){" +
        "  return !!(" +
        "    document.querySelector('#id_line') || document.querySelector('#Id_line') ||" +
        "    document.querySelector('#cont')" +
        "  );" +
        "})()";

    var raw = await _web.CoreWebView2.ExecuteScriptAsync(js);
    return raw.Contains("true", StringComparison.OrdinalIgnoreCase);
}

private async Task<(int rowCount, string firstKey)> JsGetTableSignatureAsync()
{
    // ✅ 테이블이 없으면 (0,"")
    // ✅ 있으면 row count + 첫 행의 ip/host(네 인덱스 5,6)로 서명 생성
    string js =
        "(function(){" +
        "  var rows = document.querySelectorAll('#seltable tbody tr');" +
        "  if (!rows || rows.length === 0) return JSON.stringify({c:0,k:''});" +
        "  var tds = rows[0].querySelectorAll('td');" +
        "  var ip = (tds && tds.length>6) ? (tds[5].innerText||'').trim() : '';" +
        "  var host = (tds && tds.length>6) ? (tds[6].innerText||'').trim() : '';" +
        "  return JSON.stringify({c:rows.length,k:(ip+'|'+host)});" +
        "})()";

    var raw = await _web.CoreWebView2.ExecuteScriptAsync(js);

    // WebView2 반환은 JSON string이므로 한 번 풀기
    var jsonText = System.Text.Json.JsonSerializer.Deserialize<string>(raw) ?? "{\"c\":0,\"k\":\"\"}";
    using var doc = System.Text.Json.JsonDocument.Parse(jsonText);

    int c = 0;
    string k = "";
    if (doc.RootElement.TryGetProperty("c", out var pc)) c = pc.GetInt32();
    if (doc.RootElement.TryGetProperty("k", out var pk)) k = pk.GetString() ?? "";

    return (c, k);
}

private void StartAutoExtractWatcher()
{
    if (_autoExtractTimer != null) return;

    _autoExtractTimer = new System.Windows.Forms.Timer();
    _autoExtractTimer.Interval = 200; // ✅ 항상 200ms로 가도 부담 거의 없음(짧은 로딩 놓치지 않게)

    _autoExtractTimer.Tick += async (s, e) =>
    {
        if (_autoExtractBusy) return;
        if (_web.CoreWebView2 == null) return;

        _autoExtractBusy = true;
        try
        {
            // 1) 로딩 오버레이가 보이면 추출 금지(아직 갱신 중)
            bool isLoading = await JsHasLoadingOverlayAsync();
            if (isLoading) return;

            // 2) 로딩이 없을 때 테이블 시그니처 확인
            var sig = await JsGetTableSignatureAsync();

            // 테이블이 아직 없으면 스킵
            if (sig.rowCount <= 0) return;

            // 3) "테이블 내용이 바뀐 순간"에만 자동 추출
            // (오버레이를 못 봐도 변화가 생기면 잡힘)
            bool changed = (sig.rowCount != _lastRowCount) || !string.Equals(sig.firstKey, _lastFirstKey, StringComparison.Ordinal);

            if (!changed) return;

            _lastRowCount = sig.rowCount;
            _lastFirstKey = sig.firstKey;

            await ExtractAndShowAsync();
        }
        catch
        {
            // 무시(일시 DOM 변경/로그인 전/전환 중)
        }
        finally
        {
            _autoExtractBusy = false;
        }
    };

    _autoExtractTimer.Start();
}
